# **Caso práctico**

# ¿Cómo lograr el éxito rápido de un negocio de bicicletas compartidas?

# Escenario:

# Eres un analista de datos júnior que trabaja en el equipo de analistas de marketing de Cyclistic, una empresa de bicicletas compartidas de Chicago. La directora de marketing cree que el éxito futuro de la empresa 
# depende de maximizar la cantidad de membresías anuales. Por lo tanto, tu equipo quiere entender qué diferencias existen en el uso de las bicicletas Cyclistic entre los ciclistas ocasionales y los miembros anuales. 
# A través de estos conocimientos, tu equipo diseñará una nueva estrategia de marketing para convertir a los ciclistas ocasionales en miembros anuales. Sin embargo, antes de eso, los ejecutivos de Cyclistic deben 
# aprobar tus recomendaciones; por eso, debes respaldar tu propuesta con una visión convincente de los datos y visualizaciones profesionales de los mismos.

# Personajes y equipos:

# ● Cyclistic: Un programa de bicicletas compartidas que incluye 5,800 bicicletas y 600 estaciones. Cyclistic se destaca por ofrecer también bicicletas reclinadas, triciclos manuales y bicicletas de carga que ofrecen
# un uso más inclusivo de las bicicletas compartidas para las personas con discapacidad y los ciclistas que no pueden utilizar una bicicleta estándar de dos ruedas. La mayoría de los ciclistas eligen las bicicletas 
# tradicionales, alrededor de un 8% de los ciclistas usan las opciones asistidas. Los usuarios de Cyclistic son más propensos a utilizar la bicicleta para recreación, pero alrededor del 30% la utiliza para ir al trabajo
# cada día.

# ● Lily Moreno: La directora de marketing y tu gerente. Moreno es responsable del desarrollo de campañas e iniciativas para promover el programa de bicicletas compartidas. Las campañas pueden incluir correo electrónico, 
# redes sociales y otros canales.

# ● Equipo de análisis computacional de datos de marketing de Cyclistic: Un equipo de analistas de datos que se encargan de recopilar, analizar e informar datos que ayudan a conducir la estrategia de marketing de
# Cyclistic. Te incorporaste a este equipo hace seis meses y te has dedicado no solo a conocer la misión y las metas de negocios de Cyclistic, sino también a ver cómo puedes ayudar a Cyclistic a lograrlo, desde tu
# posición de analista de datos júnior.

# ● Equipo ejecutivo de Cyclistic: El equipo ejecutivo, sumamente detallista, decidirá si aprueba el programa de marketing recomendado.

# Acerca de la empresa:

# En 2016, Cyclistic lanzó una exitosa oferta de bicicletas compartidas. Desde entonces, el programa creció hasta alcanzar una flota de 5,824 bicicletas georreferenciadas y bloqueadas en una red de 692 estaciones en
# toda Chicago. Las bicicletas se pueden desbloquear desde una estación y devolverse en cualquier otra estación del sistema en cualquier momento.

# Hasta ahora, la estrategia de marketing de Cyclistic se basaba en la construcción de un reconocimiento de marca general y en atraer a amplios segmentos de consumidores. Uno de los enfoques que ayudó a hacer esto
# posible fue la flexibilidad de sus planes de precios: pases de un solo viaje, pases de un día completo y membresías anuales. A los clientes que compran pases de un solo viaje o pases de un día completo se los llama 
# ciclistas ocasionales. Los clientes que compran membresías anuales se llaman miembros de Cyclistic.

# Los analistas financieros de Cyclistic llegaron a la conclusión de que los miembros anuales son mucho más rentables que los ciclistas ocasionales. Aunque la flexibilidad de precios ayuda a Cyclistic a atraer más
# clientes, Moreno cree que maximizar el número de miembros anuales será clave para el crecimiento futuro. En lugar de crear una campaña de marketing que apunte a todos los clientes nuevos, Moreno cree que hay muchas
# posibilidades de convertir a los ciclistas ocasionales en miembros. Ella señala que los ciclistas ocasionales ya conocen el programa de Cyclistic y han elegido a Cyclistic para sus necesidades de movilidad.

# Moreno estableció una meta clara: Diseñar estrategias de marketing orientadas a convertir a los ciclistas ocasionales en miembros anuales. Sin embargo, para hacer eso, el equipo de analistas de marketing necesita 
# entender mejor cómo difieren los miembros anuales y los ciclistas ocasionales, por qué los ciclistas ocasionales comprarían una membresía y cómo los medios digitales podrían afectar sus tácticas de marketing. 
# Moreno y su equipo están interesados en analizar los datos históricos de viajes en bicicleta de Cyclistic para identificar tendencias.

# Tres preguntas guiarán el futuro programa de marketing:

# ¿En qué se diferencian los socios anuales y los ciclistas ocasionales con respecto al uso de las bicicletas de Cyclistic?
# ¿Por qué los ciclistas ocasionales comprarían membresías anuales de Cyclistic?
# ¿Cómo puede usar Cyclistic los medios digitales para influenciar a los ciclistas ocasionales a convertirse en miembros?
# Moreno te asignó la primera pregunta por responder: ¿En qué se diferencian los socios anuales y los ciclistas ocasionales con respecto al uso de las bicicletas de Cyclistic?

# Crearás un informe con los siguientes entregables:

# Una instrucción clara de la tarea empresarial
# Una descripción de todas las fuentes de datos utilizadas
# Documentación de todas las limpiezas y manipulaciones de datos
# Un resumen de tu análisis
# Visualizaciones de respaldo y hallazgos clave
# Las tres recomendaciones más importantes basadas en tu análisis
# Preguntas Claves

# ¿Cuál es el problema que intentas resolver?

# El problema a resolver en este caso es encontrar pistas que nos permitan comprender las diferencias entre los socios anuales y ciclistas ocasionales que utilizan bicicletas arrendadas en la ciudad de Chicago, 
# tratando de comprender por qué los ciclistas ocasionales no se convierten en socios .

# ¿Cómo tus conocimientos pueden impulsar las decisiones empresariales?

# Analizar la data disponible mediante el marco de referencia y herramientas de análisis de datos nos permitirá encontrar insights que sirvan para generar nuevas y mejores estrategias de marketing con la finalidad
# de convertir a los ciclistas ocasionales en miembros anuales maximizando la cantidad de membresías anuales.

# Tareas clave:

# Identificar la tarea empresarial: Analizar data disponible y encontrar insights para mejorar estrategia de Marketing.
# Considerar a los interesados clave: Lily Moreno, Equipo de análisis computacional de datos de marketing de Cyclistic, Equipo ejecutivo de Cyclistic.
# Entregable

# Informe con recomendaciones basadas en el análisis de los datos disponibles.

# ¿Dónde se ubican tus datos?

# Los datos corresponden a datos publicos proporcionados por Motivate International Inc. bajo licencia.

# ¿Cómo están organizados los datos?

# Los datos están organizados en archivos de formato CSV y pueden ser encontrados en la siguiente dirección electrónica: https://divvy-tripdata.s3.amazonaws.com/index.html.

# ¿Hay problemas con el sesgo o la credibilidad de estos datos? ¿Tus datos son confiables, originales, integrales, actuales y citados (ROCCC)?

# Reliable - Medio - La data contiene una amplia variedad de archivos (Mensuales, anuales y trimestrales). Original - Bajo- Third party provider (Motivate International Inc) Comprehensive - Alta - Los parámetros de
# la data permiten realizar el análisis, ya que coinciden con nuestro negocio. Current - Alta - La data está recolectada hasta mayo 2023. Cited - Medio - La data está recolectada desde un Third party provider.

# ¿Cómo estás abordando la autorización, la privacidad, la seguridad y la accesibilidad?

# Dada la protección de datos personales no está permitido utilizar o acceder a la información de identificación personal de los ciclistas, lo que conlleva a no poder analizar variables demográficas y sociodemográficas.

# ¿Cómo verificaste la integridad de los datos?

# Los datos presentan en el mismo formato para todos los archivos, tienen una descripción clara de identificación, es decir, están estandarizados y se encuentran completos y sin typos, por ende los datos no presentan
# mayores problemas.

# ¿Qué herramientas eliges y por qué?

# Para este informe utilizaré el lenguaje de programación R, dado que nos permite procesar gran cantidad de datos, transformarlos, limpiarlos y visualizarlos todo en un mismo lugar.

# ¿Has garantizado la integridad de los datos?

# Para garantizar la integridad de los datos utilizaremos R para limpiar y transformar la data.

# Informe:

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
# Paso 1:                                                                     #
# Instalar paquetes de librerías necesarias para el análisis.                 #
# tidyverse para importar data y wrangling (convertir data en data usable)    #
# lubridate for date functions                                                #
# ggplot for visualization                                                    #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 

# Instalar paquetes en caso de no estar instalados en R:

install.packages("tidyverse")
install.packages("lubridate")
install.packages("ggplot2")

# Llamar librerías para poder utilizar sus funciones:

library(tidyverse)  
library(lubridate)  
library(ggplot2)   

#=====================
# Paso 1: Importar Data
#=====================

# Para acceder a la Data ir a https://divvy-tripdata.s3.amazonaws.com/index.html.
# Descargar los últimos 12 meses de datos de viajes "Divvy datasets (csv files)".

# Cargando Data en R, con tu propio directorio:

#May_2023 <- read.csv("202305-divvy-tripdata.csv")
#Abr_2023 <- read.csv("202304-divvy-tripdata.csv")
#Mar_2023 <- read.csv("202303-divvy-tripdata.csv")
#Feb_2023 <- read.csv("202302-divvy-tripdata.csv")
#Ene_2023 <- read.csv("202301-divvy-tripdata.csv")
#Dic_2022 <- read.csv("202212-divvy-tripdata.csv")
#Nov_2022 <- read.csv("202211-divvy-tripdata.csv")
#Oct_2022 <- read.csv("202210-divvy-tripdata.csv")
#Sep_2022 <- read.csv("202209-divvy-publictripdata.csv")
#Ago_2022 <- read.csv("202208-divvy-tripdata.csv")
#Jul_2022 <- read.csv("202207-divvy-tripdata.csv")
#Jun_2022 <- read.csv("202206-divvy-tripdata.csv")

#====================================================
# Paso 2: Combinar archivos CSV en 1 solo gran archivo
#====================================================

# Verificar que todos los archivos tengan las mismas columnas para posteriormente consolidar en un único archivo:

colnames(May_2023)
colnames(Abr_2023)
colnames(Mar_2023)
colnames(Feb_2023)
colnames(Ene_2023)
colnames(Dic_2022)
colnames(Nov_2022)
colnames(Oct_2022)
colnames(Sep_2022)
colnames(Ago_2022)
colnames(Jul_2022)
colnames(Jun_2022)

# Combinar todos los archivos en una gran DATAFRAME, considerando los últimos 12 periodos:

viajes <- bind_rows(May_2023
                    ,Abr_2023
                    ,Mar_2023
                    ,Feb_2023
                    ,Ene_2023
                    ,Dic_2022
                    ,Nov_2022
                    ,Oct_2022
                    ,Sep_2022
                    ,Ago_2022
                    ,Jul_2022
                    ,Jun_2022)

# Verificar nuevo archivo combinado:

View(viajes)
class(viajes) # DataFrame con 5,829,030 entradas y 14 columnas totales.

# Quitar las columnas start_lat, start_lng, end_lat, end_lng, debido a que esta información fue dada de baja en 2020:

viajes <- viajes %>%  
  select(-c(start_lat, start_lng, end_lat, end_lng))

#======================================================
# Paso 3: Limpieza y adición de nueva data para pasar a la etapa de Análisis.
#======================================================

# Inspeccionar la nueva data creada:

colnames(viajes)  #Lista de columnas
nrow(viajes)  #Cuantas filas tiene la data frame
dim(viajes)  #Dimensiones de la data frame
head(viajes)  #Ver las primeras 6 filas de la data frame.  También puedes usar: tail(all_trips)
str(viajes)  #Ver lista de columnas y sus tipos de datos que contiene (numerico, caracteres, etc)
summary(viajes)  #Resumen estadístico de la data. Principalmente para variables de tipo numérico.

# Existen algunos problemas con la data que deben ser corregidos antes del análisis:

# (1) En la columna "member_casual", Hay dos nombres para members ("member" and "Subscriber") y dos para casual riders 
# ("Customer" and "casual"). Necesitamos consolidar estos datos en para que tener solo 2 tipos, members y casuals.

# (2) La data puede ser agregada solo al nivel de ride, el cual es muy granular. Necesitamos añadir más columnas como
# día, mes, año -- que nos proporcione más información en el análisis.
# (3) Necesimos crear una columna de length of ride, en este caso será "ride_length" a toda la dataframe, que es la duración de cada viaje en 
# bicicleta, se calcula como ended_at - started_at, es decir, la diferencia entre fechas y tiempo. 
# (4) Tenemos algunos viajes que muestran un resultado negativo, incluye aproximadamente 1000 viajes donde Divvy quito bicicletas de circulación,
# por ello, necesitamos borrar esos viajes.

# Reasignando member_casual para consolidar en 2 grandes grupos "Member" y "Casual"

table(viajes$member_casual) # Verificamos el número de observaciones para comparar con el resultado.

# Resultados:
#  casual  member 
# 2312073 3516957 

viajes <-  viajes %>% 
  mutate(member_casual = recode(member_casual
                                ,"Subscriber" = "member"
                                ,"Customer" = "casual"))

table(viajes$member_casual) # Verificamos el número de observaciones obtenidas.

# Resultados:
#  casual  member 
# 2312073 3516957 

View(viajes) # Ahora solo figuran member y casual en la columna member_casual.
str(viajes) # Verificar estructura.

# Añadir columnas con, día, mes y año para cada viaje.
# Esto nos permitira realizar cálculos con nuestra data.
# Podemos ver nuestra data no contiene una columna Date, por ello utilizaremos la fecha de inicio de viajes "started_at" para crearla.

viajes$date <- as.Date(viajes$started_at,format='%Y-%m-%d %H:%M:%S') # Debemos crear una nueva columna de clase DATE, por ello es necesario
                                                                     # usar una columna con fecha, pero en este caso es de tipo caracteres
                                                                     # por ello, usamos as.Date y hacemos MATCH con el formato de la fecha
                                                                     # que contiene la columna.
viajes$month <- month(ymd(viajes$date)) # Creamos variable mes.
viajes$day <- day(viajes$date)          # Creamos variable dia.
viajes$year <- year(viajes$date)        # Creamos variable año.
viajes$day_of_week <- wday(viajes$date) # Creamos variable día de la semana.

str(viajes)

# En este punto conviene crear una copia de nuestra tabla, para evitar perder todo lo avanzado:

viajes_2 <- viajes

View(viajes_2)

str(viajes_2) # Verificamos la estructura de nuestra Data Frame

# Necesitamos crear la columna ride_length, es decir, duración de cada viaje, para ello usaremos la diferencia entre
# ended_at  y started_at, pero primero necesitamos que sea de tipo Date, usaremos as.POSIXct que permite restar fechas.

# Cambiamos el tipo de data para started_at:

viajes_2$started_at <- viajes_2$started_at <- as.POSIXct(x = as.character(viajes_2$started_at), 
                                                                 format='%Y-%m-%d %H:%M:%S')

str(viajes_2) # Verificamos el tipo de data que es started_at.

# Cambiamos el tipo de data para ended_at:

viajes_2$ended_at <- viajes_2$ended_at <- as.POSIXct(x = as.character(viajes_2$ended_at), 
                                                             format='%Y-%m-%d %H:%M:%S')

str(viajes_2) # Verificamos el tipo de data que es ended_at.

# Creamos una nueva columna "ride_length" (medida en segundos)

viajes_2 <- viajes_2 %>% 
  mutate(ride_length = ended_at - started_at)

View(viajes_2)

# Convertimos "ride_length" a numeric para hacer cálculos.

is.factor(viajes_2$ride_length)

viajes_2$ride_length <- as.numeric(as.character(viajes_2$ride_length))

is.numeric(viajes_2$ride_length)

# Convertimos ride_length a minutos

viajes_2 <- viajes_2 %>% 
  mutate(ride_length_minutes = (ended_at - started_at)/60)

is.factor(viajes_2$ride_length_minutes)

viajes_2$ride_length_minutes <- as.numeric(as.character(viajes_2$ride_length_minutes))

is.numeric(viajes_2$ride_length_minutes)

str(viajes_2) # Verificamos nuestros datos.

# Removimos "bad" data
# La dataframe contiene unos cuantos 1000 de entradas con valores negativos, dado que fueron sacadas de circulación para pruebas de calidad. 

# Creamos una nueva dataframe quitando los bad data.

viajes_2_v3 <- viajes_2[!(viajes_2$start_station_name == "HQ QR" | viajes_2$ride_length<0),]

str(viajes_2)
View(viajes_2_v3)

# Paso 4: Realizando un análisis descriptivo de la data
#=====================================
# Análisis descriptivo sobre ride_length.

#Comprobando si la data contiene NA, ya que sino no podremos realizar cálculos:

# Sumar la cantidad de NA presentes en la data
sum(is.na(viajes_2_v3$ride_length_minutes)) 

mean(viajes_2_v3$ride_length_minutes)
 
#La data contiene 5827892 datos buenos
sum(!is.na(viajes_2_v3$ride_length_minutes)) 

# El porcentaje de NAs presentes en la columna ride_length_minutes corresponde a un 0% de los datos.
(sum(is.na(viajes_2_v3$ride_length_minutes)) / sum(!is.na(viajes_2_v3$ride_length_minutes))) *100

# Análisis descriptivo sobre ride_length (Todas las variables en segundos)

mean(viajes_2_v3$ride_length)             # La media de todos los viajes (total ride_length/rides).
mean(viajes_2_v3$ride_length,na.rm = T)   # En caso de contener NAs.

median(viajes_2_v3$ride_length)           # Número medio ordenado de forma ascendente de la columna ride_length.
median(viajes_2_v3$ride_length,na.rm = T) # En caso de contener NAs.

max(viajes_2_v3$ride_length)              # Viaje más largo.
max(viajes_2_v3$ride_length,na.rm = T)    # En caso de contener NAs.

min(viajes_2_v3$ride_length)              # Viaje más corto.
min(viajes_2_v3$ride_length,na.rm = T)    # En caso de contener NAs.

summary(viajes_2_v3$ride_length) # Otra forma de realizar un análisis descriptivo de forma más rápida y ordenada.

# Calculamos el promedio de tiempo de viaje por cada día para usuarios members vs casual 

aggregate(viajes_2_v3$ride_length ~ viajes_2_v3$member_casual + viajes_2_v3$day_of_week, FUN = mean)

# Podemos notar que los días de la semana no están ordenados, por ello creamos una lista para ordenar según nuestras necesidades:
# En este caso utilizamos Sunday 1 y Saturday 7.

viajes_2_v3$day_of_week <- ordered(viajes_2_v3$day_of_week, levels=c("Sunday", 
                                                                     "Monday", 
                                                                     "Tuesday", 
                                                                     "Wednesday",
                                                                     "Thursday", 
                                                                     "Friday", 
                                                                     "Saturday"))

# Ahora calculamos el tiempo promedio de viajes por cada día para usuarios members vs casual, pero con el orden deseado:

aggregate(viajes_2_v3$ride_length ~ viajes_2_v3$member_casual + viajes_2_v3$day_of_week, FUN = mean)

# Analizamos la cantidad de viajes por día de la semana y su media:

viajes_2_v3 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>%  #creates weekday field using wday()
  group_by(member_casual, weekday) %>%  #groups by usertype and weekday
  summarise(number_of_rides = n()							#calculates the number of rides and average duration 
            ,average_duration = mean(ride_length)) %>% 		# calculates the average duration
  arrange(member_casual, weekday)

# Visualizamos el número de viajes por semana por tipo de usuario:

viajes_2_v3 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(ride_length)) %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge")

